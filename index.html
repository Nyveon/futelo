<!DOCTYPE html>
<html lang="en">
	<head>
		<script src="https://telegram.org/js/telegram-web-app.js?56"></script>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Futelo</title>
		<script
			defer
			src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
		></script>

		<style>
			/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */
			button,
			hr,
			input {
				overflow: visible;
			}
			progress,
			sub,
			sup {
				vertical-align: baseline;
			}
			[type="checkbox"],
			[type="radio"],
			legend {
				box-sizing: border-box;
				padding: 0;
			}
			html {
				line-height: 1.15;
				-webkit-text-size-adjust: 100%;
			}
			body {
				margin: 0;
			}
			details,
			main {
				display: block;
			}
			h1 {
				font-size: 2em;
				margin: 0.67em 0;
			}
			hr {
				box-sizing: content-box;
				height: 0;
			}
			code,
			kbd,
			pre,
			samp {
				font-family: monospace, monospace;
				font-size: 1em;
			}
			a {
				background-color: transparent;
			}
			abbr[title] {
				border-bottom: none;
				text-decoration: underline;
				text-decoration: underline dotted;
			}
			b,
			strong {
				font-weight: bolder;
			}
			small {
				font-size: 80%;
			}
			sub,
			sup {
				font-size: 75%;
				line-height: 0;
				position: relative;
			}
			sub {
				bottom: -0.25em;
			}
			sup {
				top: -0.5em;
			}
			img {
				border-style: none;
			}
			button,
			input,
			optgroup,
			select,
			textarea {
				font-family: inherit;
				font-size: 100%;
				line-height: 1.15;
				margin: 0;
			}
			button,
			select {
				text-transform: none;
			}
			[type="button"],
			[type="reset"],
			[type="submit"],
			button {
				-webkit-appearance: button;
			}
			[type="button"]::-moz-focus-inner,
			[type="reset"]::-moz-focus-inner,
			[type="submit"]::-moz-focus-inner,
			button::-moz-focus-inner {
				border-style: none;
				padding: 0;
			}
			[type="button"]:-moz-focusring,
			[type="reset"]:-moz-focusring,
			[type="submit"]:-moz-focusring,
			button:-moz-focusring {
				outline: ButtonText dotted 1px;
			}
			fieldset {
				padding: 0.35em 0.75em 0.625em;
			}
			legend {
				color: inherit;
				display: table;
				max-width: 100%;
				white-space: normal;
			}
			textarea {
				overflow: auto;
			}
			[type="number"]::-webkit-inner-spin-button,
			[type="number"]::-webkit-outer-spin-button {
				height: auto;
			}
			[type="search"] {
				-webkit-appearance: textfield;
				outline-offset: -2px;
			}
			[type="search"]::-webkit-search-decoration {
				-webkit-appearance: none;
			}
			::-webkit-file-upload-button {
				-webkit-appearance: button;
				font: inherit;
			}
			summary {
				display: list-item;
			}
			[hidden],
			template {
				display: none;
			}
			.editable-section {
				display: flex;
				flex-direction: row;
				align-items: center;
				margin-bottom: 20px;
			}
		</style>

		<style>
			:root {
				--color-background: #333;
				--color-background-light: #444;
				--color-background-dark: #222;
				--color-text: #f5f5f5;
				--color-primary: #24a1de;
				--color-warn: oklch(70% 0.15 21);
				--color-warn-dark: oklch(50% 0.1 20);
			}

			body {
				background-color: var(--color-background);
				color: var(--color-text);
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
					"Helvetica Neue", Arial, sans-serif;
			}

			main {
				max-width: 900px;
				margin: 0 auto;
				padding: 20px;
			}

			h1,
			h2 {
				text-align: center;
			}

			div[contenteditable="true"] {
				border: 1px solid #ccc;
				padding: 8px;
				min-height: 40px;
				outline: none;
				white-space: pre-wrap;
				font-size: 1.5rem;
				width: 100%;
			}

			ul {
				list-style-type: none;
				padding: 0;
			}

			.inventory {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
				gap: 10px;
			}

			.item {
				display: flex;
				justify-content: space-around;
				background-color: var(--color-background-dark);
				border-radius: 5px;
				padding-inline: 5px;
				padding-block: 2px;
			}

			pre {
				margin: 0.25rem;
				font-family: "Courier New", Courier, monospace;
			}

			.freq {
				color: var(--color-text);
			}

			.f0 {
				background-color: var(--color-background-light);
			}

			.f1 {
				background-color: oklch(70% 0.1197 270);
			}

			.f2 {
				background-color: oklch(70% 0.1197 230);
			}

			.f3 {
				background-color: oklch(70% 0.1197 190);
			}

			.f4 {
				background-color: oklch(70% 0.1197 150);
			}

			.f5 {
				background-color: oklch(70% 0.1197 110);
			}

			.f6 {
				background-color: oklch(70% 0.1197 70);
			}

			.fx {
				color: var(--color-warn);
			}

			.t0 {
				color: var(--color-text);
			}

			.t1 {
				color: oklch(70% 0.1197 270);
			}

			.t2 {
				color: oklch(70% 0.1197 230);
			}

			.t3 {
				color: oklch(70% 0.1197 190);
			}

			.t4 {
				color: oklch(70% 0.1197 150);
			}

			.t5 {
				color: oklch(70% 0.1197 110);
			}

			.t6 {
				color: oklch(70% 0.1197 70);
			}

			.tx {
				color: var(--color-warn);
			}

			body:has(.fx) div[contenteditable="true"] {
				background-color: var(--color-warn-dark);
			}

			@media screen and (max-width: 600px) {
				h1 {
					padding-top: 0;
				}

				main {
					padding-top: 0;
				}

				ul.inventory {
					gap: 5px;
				}

				pre {
					margin: 0.1rem;
				}
			}
		</style>
	</head>
	<body
		x-data="{
		user_stats: null,
		valid: true,
		letter_limits: {
            'a': 6,
            'b': 6,
            'c': 6,
            'd': 6,
            'e': 6,
            'f': 6,
            'g': 6,
            'h': 6,
            'i': 6,
            'j': 6,
            'k': 6,
            'l': 6,
            'm': 6,
            'n': 6,
			'ñ': 6,
            'o': 6,
            'p': 6,
            'q': 6,
            'r': 6,
            's': 6,
            't': 6,
            'u': 6,
            'v': 6,
            'w': 6,
            'x': 6,
            'y': 6,
            'z': 6,
            '#': 6,
            '?': 6,
        },
		LETTERS: 'abcdefghijklmnñopqrstuvwxyz#?',
		mapLetterLimits(letter_limits_list){
			this.letter_limits = {};
			for (let i = 0; i < letter_limits_list.length; i++){
				this.letter_limits[this.LETTERS[i]] = letter_limits_list[i];
			}
		},
		getUserStats(){
			var userId = new URLSearchParams(window.location.search).get('user_id');
			if ( (!userId) && (window.Telegram.WebApp.initDataUnsafe.user) ){
				userId = window.Telegram.WebApp.initDataUnsafe.user.id;
			}
			if (userId){
				// THIS URL HAS TO BE CHANGED
				fetch('http://164.92.91.99:8000/stats?user_id=' + userId)
				.then(response => response.json())
				.then(data => {
					if (data.error) {
						console.error(data.error);
						return;
					}
					this.user_stats = data;
					this.mapLetterLimits(data.letter_limits_list);
				})
				.catch(error => console.error(error));
			}
		},
        categories: {
            'a': 0,
            'b': 0,
            'c': 0,
            'd': 0,
            'e': 0,
            'f': 0,
            'g': 0,
            'h': 0,
            'i': 0,
            'j': 0,
            'k': 0,
            'l': 0,
            'm': 0,
            'n': 0,
			'ñ': 0,
            'o': 0,
            'p': 0,
            'q': 0,
            'r': 0,
            's': 0,
            't': 0,
            'u': 0,
            'v': 0,
            'w': 0,
            'x': 0,
            'y': 0,
            'z': 0,
            '#': 0,
            '?': 0,
        },
		categoryLimit(category){
			return this.letter_limits[category];
		},
        frequencyText(category, count, limit) {
            if (count > limit) {
                return `${category} | ${count.toString().padEnd(limit, ' ')}`;
            }
            const bars = '■'.repeat(count);
            const spaces = '□'.repeat(limit - count);
            return `${category} | ${bars}${spaces}`;
        },
        normalizeText(text) {
            return text.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        },
		characterCategory(char){
			if (this.categories.hasOwnProperty(char)) {
				return char
			} else if (!isNaN(char)) {
				return '#'
				this.categories['#']++;
			} else if (/[^a-z0-9]/.test(char)) {
				return '?'
			}
		},
		checkValid(text){
			for (let char of text){
				if (this.getCharClass(char) == 'tx'){
					return false;
				}
			}
			return true;
		},
        updateCategories() {
            const originalText = this.$refs.editable.innerText
            const text = this.normalizeText(originalText);
            Object.keys(this.categories).forEach(key => this.categories[key] = 0);
            if (!text) return;
            for (let char of text) {
                if (/\s/.test(char)) continue;
                if (this.categories.hasOwnProperty(char)) {
                    this.categories[char]++;
                } else if (!isNaN(char)) {
                    this.categories['#']++;
                } else if (/[^a-z0-9]/.test(char)) {
                    this.categories['?']++;
                }
            }

            this.applyColoredText(originalText);
			this.valid = this.checkValid(text);
        },
        getFrequencyClass(category,count) {
            if (count > this.letter_limits[category]) return 'tx';
            return `t${count}`;
        },
		getOtherFrequencyClass(category,count) {
			if (count > this.letter_limits[category]) return 'fx';
			return `f${count}`;
		},
        getCharClass(char) {
            const normalizedChar = this.normalizeText(char);

            let count = this.categories[normalizedChar] || (/\d/.test(char) ? this.categories['#'] : this.categories['?']);
            return this.getFrequencyClass(this.characterCategory(normalizedChar) , count);
        },
        applyColoredText(text) {
            const selection = window.getSelection();
            const range = selection.getRangeAt(0);
            const preCaretRange = range.cloneRange();
            preCaretRange.selectNodeContents(this.$refs.editable);
            preCaretRange.setEnd(range.startContainer, range.startOffset);
            const cursorPosition = preCaretRange.toString().length;

            let coloredHTML = '';
            for (let char of text) {
                const className = this.getCharClass(char);
                coloredHTML += `<span class='${className}'>${char}</span>`;
            }

            this.$refs.editable.innerHTML = coloredHTML;

            this.restoreCursorPosition(cursorPosition);
        },

        restoreCursorPosition(cursorPosition) {
            const selection = window.getSelection();
            const range = document.createRange();

            let charCount = 0;
            const nodes = this.$refs.editable.childNodes;

            for (let node of nodes) {
                if (node.nodeType === Node.TEXT_NODE) {
                    const textLength = node.length;
                    if (charCount + textLength >= cursorPosition) {
                        range.setStart(node, cursorPosition - charCount);
                        range.collapse(true);
                        break;
                    }
                    charCount += textLength;
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    const textLength = node.textContent.length;
                    if (charCount + textLength >= cursorPosition) {
                        range.setStart(node.firstChild || node, cursorPosition - charCount);
                        range.collapse(true);
                        break;
                    }
                    charCount += textLength;
                }
            }
            selection.removeAllRanges();
            selection.addRange(range);
        },
		goToTelegram() {
            const text = this.$refs.editable.innerText;
			window.location.href = `https://t.me/share?url=${encodeURIComponent(text)}`;
        },
    }"
	x-init="getUserStats"
	>

		<main>
			<h1>Futelo</h1>

			
			<section class="editable-section">
				<div
					contenteditable="true"
					x-ref="editable"
					@input="updateCategories"
				></div>
				<button style="min-height: 60px; min-width: 60px;" x-on:click="goToTelegram()" x-bind:disabled="!valid">→</button>
			</section>

			<section>
				<ul class="inventory">
					<template x-for="(count, category) in categories">
						<li class="item" :class="getOtherFrequencyClass(category, count)">
							<pre
								class="freq"
								:class="(count > categoryLimit(category)) && 'fx'"
								x-text="frequencyText(category, count, categoryLimit(category))"
							></pre>
						</li>
					</template>
				</ul>
			</section>
		</main>
	</body>
</html>
